---
slug: gosu-usage
title: gosu：容器環境下的使用者切換工具
authors: TSE
tags: [docker, gosu, sudo, container]
---

容器技術，尤其是 Docker，已經革命化了應用的部署和管理方式，提供了前所未有的靈活性和可靠性。這種技術允許開發者將應用及其依賴打包在一起，確保在不同的環境中一致地運行。然而，這種新的部署方式也帶來了新的挑戰。

<!--truncate-->

### 可能問題 1：TTY 轉換

在Docker容器中使用su或sudo啟動一個需要與終端交互的應用程序，比如一個文本編輯器。

當你通過su或sudo執行這類應用時，這些應用可能無法正確地檢測到終端（TTY），因為 su 和 sudo 在創建新會話時可能不會適當地處理終端的所有权和控制。結果，這些需要與終端交互的應用可能無法正常運行，或者在試圖使用它們時遇到輸入/輸出錯誤。

### 可能問題 2：信號轉發

在容器中使用 su 或 sudo 啟動長時間運行的進程，如一個 Web 服務器。

當使用 su 或 sudo 啟動這樣的進程時，這些工具會創建一個新的進程來執行指定的命令。這意味著當宿主機或容器管理系統嘗試停止或重啟這個進程時，信號可能不會被正確地轉發給最終的子進程。例如，當發送 SIGTERM 信號給 sudo 或 su 啟動的進程時，該信號可能不會傳遞給實際運行的 Web 服務器進程，導致無法正常停止或清理。

這些問題的根本原因在於 su 和 sudo 的設計初衷並不是為了處理容器這樣的輕量化虛擬化環境。它們在執行命令時創建新的會話，可能不會考慮到容器環境中的特殊需求，例如需要保留終端控製或確保信號能夠直接傳遞給目標進程，以便這些進程可以正常運行和優雅終止。這就是為什麼在容器環境中建議使用 gosu 或其他專為容器設計的工具來代替 su 和 sudo，因為它們能夠更好地處理這些特定的互動和訊號問題。

### `gosu`的設計理念和核心優勢

`gosu` 是一個專門為了容器（比如Docker容器）設計的工具，它的目的是讓在容器內部執行命令變得更簡單和安全。當你需要以不同的用戶身份（比如從管理員變成普通用戶）來運行某個程序時，`gosu` 就能派上用場。這個工具的靈感來自於 Docker 啟動程序的方式，甚至直接使用了 Docker 用來識別用戶的一些技術，這就確保了 `gosu` 能夠很好地和 Docker 配合使用。

簡單來說，`gosu`就像是一個幫手，當你告訴它「請以這個用戶的身份執行這個命令」時，它就會幫你做到，而且做完之後就會退出，不會留下任何痕迹。這種做法避免了一些技術上的麻煩，比如程序之間的信息傳遞和控制終端的問題，讓一切都變得更加順暢。

### 實際應用場景

在 Docker 容器的 ENTRYPOINT 腳本中使用 gosu 是一個非常典型的應用場景，尤其當我們需要從 root 用戶降級到非特權用戶來執行某些操作時。這種做法對於保護容器運行環境的安全至關重要，因為它能有效減少潛在的安全風險。

安裝 gosu 非常簡單，通常只需要在 Dockerfile 中添加幾行指令即可完成安裝和配置。下面的範例展示了如何在 Dockerfile 中安裝 gosu，並通過一個入口點腳本來動態創建用戶和用戶組，然後使用 gosu 以指定的用戶身份執行命令。

```Dockerfile
# 基於一個已有的基礎鏡像
FROM some_base_image:latest

WORKDIR /app

# 安裝gosu
RUN apt-get update && apt-get install -y gosu && rm -rf /var/lib/apt/lists/*

# 準備入口點腳本
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["default_command"]
```

`entrypoint.sh` 腳本的範例內容如下，它根據環境變量 USER_ID 和 GROUP_ID 動態創建用戶，然後用 gosu 執行命令：

```bash
#!/bin/bash
# 檢查是否設置了USER_ID和GROUP_ID環境變量
if [ ! -z "$USER_ID" ] && [ ! -z "$GROUP_ID" ]; then
    # 創建用戶組和用戶
    groupadd -g "$GROUP_ID" usergroup
    useradd -u "$USER_ID" -g usergroup -m user
    # 使用gosu執行命令
    exec gosu user "$@"
else
    exec "$@"
fi
```

### 安全性考量

值得一提的是，儘管 `gosu` 的主要用途是在容器啟動時從 `root` 用戶切換到非特權用戶，但其開發者也強調了在特定情境下使用 `gosu` 可能存在的安全風險。這是因為任何允許用戶切換的工具，若被不當使用，都可能打開安全漏洞的大門。因此，開發和運維團隊需要對 `gosu` 的使用場景有充分的了解，並確保其僅在安全的上下文中使用。

### 結論

`gosu` 以其簡潔、高效和安全的特點，為 Docker 容器中的用戶身份切換提供了一個理想的解決方案。它解決了長期困擾開發和運維團隊的一大痛點，並以最小的學習曲線實現了最大的使用效果。對於那些尋求在容器環境中實現靈活且安全用戶切換的團隊來說，`gosu` 無疑是一個值得探索的工具。

### 參考資料

- [gosu GitHub repository](https://github.com/tianon/gosu)
